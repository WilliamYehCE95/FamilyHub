<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ å®¶åº­ä¸­å¿ƒ - Family Hub</title>
    <!-- PWA ç›¸é—œå„ªåŒ–æ¨™ç±¤ï¼Œç¢ºä¿æ·»åŠ åˆ°ä¸»ç•«é¢æ™‚æ˜¯å…¨è¢å¹• -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å®¶åº­ä¸­å¿ƒ">

    <!-- è¼‰å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ React, ReactDOM CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- è¼‰å…¥ Babel é€²è¡Œ JSX è½‰è­¯ (åƒ…ç”¨æ–¼é–‹ç™¼/å–®æ–‡ä»¶) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase CDN for Firestore and Auth (REQUIRED for storage) -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    
    <!-- è¨­å®š Tailwind CSS é…ç½®ï¼Œä½¿ç”¨ Inter å­—é«”ä¸¦ç¢ºä¿ä¸­æ–‡å­—é«”å¯è®€ -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+TC:wght@100..900&display=swap');
        
        /* å°‡ Inter è¨­å®šç‚ºä¸»è¦å­—é«”ï¼Œä¸¦å°‡ Noto Sans TC ä½œç‚ºä¸­æ–‡å¾Œå‚™å­—é«” */
        body {
            font-family: "Inter", "Noto Sans TC", sans-serif;
            -webkit-tap-highlight-color: transparent; /* ç§»é™¤é»æ“Šæ™‚çš„è—è‰²é«˜äº® */
        }
    </style>
</head>
<body class="bg-gray-50">

    <div id="root">
        <!-- React æ‡‰ç”¨ç¨‹å¼å°‡åœ¨æ­¤è™•æ¸²æŸ“ -->
        <div class="text-center p-10">è¼‰å…¥ä¸­...</div>
    </div>

    <!-- æ‰€æœ‰çš„ React/JSX ç¨‹å¼ç¢¼æ”¾åœ¨ type="text/babel" çš„ script æ¨™ç±¤å…§ -->
    <script type="text/babel">
    const { useState, useEffect, useMemo, createContext, useContext } = React;
    const { createRoot } = ReactDOM;
    
    // --- è¼”åŠ©å‡½æ•¸ ---
    // æª¢æŸ¥ Firebase å…¨å±€å°è±¡æ˜¯å¦å¯ç”¨
    const getFirebaseDependencies = () => {
        if (typeof firebase === 'undefined' || !firebase.firestore || !firebase.auth) {
            console.error("Firebase is not initialized or CDN dependencies are missing.");
            return null;
        }
        return {
            initializeApp: firebase.initializeApp,
            getAuth: firebase.auth.getAuth,
            signInAnonymously: firebase.auth.signInAnonymously,
            signInWithCustomToken: firebase.auth.signInWithCustomToken,
            onAuthStateChanged: firebase.auth.onAuthStateChanged,
            getFirestore: firebase.firestore.getFirestore,
            collection: firebase.firestore.collection,
            onSnapshot: firebase.firestore.onSnapshot,
            addDoc: firebase.firestore.addDoc,
            query: firebase.firestore.query,
            orderBy: firebase.firestore.orderBy,
            serverTimestamp: firebase.firestore.serverTimestamp,
            setLogLevel: firebase.firestore.setLogLevel,
            // ç”±æ–¼ firestore.js 11.x ç‰ˆçš„çµæ§‹ï¼Œæˆ‘å€‘éœ€è¦ç¢ºä¿æ‰€æœ‰å‡½å¼éƒ½è¢«æ­£ç¢ºå¼•ç”¨
            ...firebase.firestore,
            ...firebase.auth,
        };
    };

    // æ ¼å¼åŒ–æ´»å‹•æ—¥æœŸé¡¯ç¤º
    const formatDate = (dateString) => {
        const date = new Date(dateString);
        return date.toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit' }).replace(/\//g, '/');
    };

    const formatTime = (dateString) => {
        const date = new Date(dateString);
        return date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false });
    };

    // --- Firebase ä¸Šä¸‹æ–‡ ---
    const FirebaseContext = createContext(null);

    // --- ç°¡åŒ–çš„ Lucide Icons (Inline SVGs) ---
    const IconWrapper = ({ children, className = 'w-6 h-6', ...rest }) => (
        <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" {...rest}>
            {children}
        </svg>
    );

    const Calendar = (props) => (<IconWrapper {...props}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></IconWrapper>);
    const Scroll = (props) => (<IconWrapper {...props}><path d="M8 21h11a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2z"></path><path d="M11 7h6"></path><path d="M11 11h6"></path><path d="M11 15h6"></path></IconWrapper>);
    const Megaphone = (props) => (<IconWrapper {...props}><path d="M3 11h3l7-7v16l-7-7H3z"></path><path d="M18 8a6 6 0 0 0 0 8"></path></IconWrapper>);
    const Trophy = (props) => (<IconWrapper {...props} fill="currentColor"><path d="M10 2l2.5 5 5-2.5-2.5 5 5 2.5-5 2.5 2.5 5-5-2.5-2.5 5v-13h-4v-4z"></path><path d="M5 22h14"></path></IconWrapper>);
    const MessageSquare = (props) => (<IconWrapper {...props}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></IconWrapper>);
    const Search = (props) => (<IconWrapper {...props}><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></IconWrapper>);
    const ChevronRight = (props) => (<IconWrapper {...props}><path d="M9 18l6-6-6-6"></path></IconWrapper>);
    const Plus = (props) => (<IconWrapper {...props}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></IconWrapper>);

    // --- æ¨¡æ“¬æ•¸æ“š (Mock Data) ---
    // ç§»é™¤ events æ•¸æ“šï¼Œæ”¹ç‚ºå¾ Firestore ç²å–
    const mockData = {
      rules: ["å°Šé‡å½¼æ­¤ï¼Œä¿æŒç¦®è²Œã€‚", "å®Œæˆå­¸æ ¡ä½œæ¥­å¾Œæ‰èƒ½ç©æ¨‚ã€‚", "ä¿æŒæˆ¿é–“æ•´æ½”ï¼Œè‡ªå·±çš„äº‹æƒ…è‡ªå·±åšã€‚", "æ™šä¸Š 9 é»æº–æ™‚ä¸ŠåºŠç¡è¦ºã€‚", "ç”¨é¤æ™‚ä¸ä½¿ç”¨é›»å­ç”¢å“ã€‚", "ä¸»å‹•å¹«åŠ©å®¶äººã€‚", ],
      honorRoll: [
        { name: "å°æ˜", points: 120, achievement: "æœ¬é€±æœ€ä½³åŠ©äººè€…" },
        { name: "å°è¯", points: 95, achievement: "é–±è®€ç¿’æ…£é€²æ­¥ç" },
        { name: "å°ç¾", points: 150, achievement: "æ•¸å­¸æ¸¬é©—æ»¿åˆ†" },
      ],
      announcements: ["æœ¬é€±æœ«å®¶åº­æ´»å‹•ï¼šé€±å…­ä¸‹åˆé‡é¤ã€‚", "è«‹æª¢æŸ¥å°æ˜æ˜¯å¦æœ‰å¸¶é«”è‚²èª²ç”¨å“ã€‚", "ä¸‹é€±ä¸‰æ™šä¸Š 7 é»å®¶åº­æœƒè­°ã€‚", ],
      queries: [
        { title: "å­¸æ ¡ç¶²ç«™", url: "#", icon: "ğŸ«" },
        { title: "ä»Šæ—¥å¤©æ°£", url: "#", icon: "â˜€ï¸" },
        { title: "åœ–æ›¸é¤¨å€Ÿé–±æŸ¥è©¢", url: "#", icon: "ğŸ“š" },
        { title: "å¥åº·ç¢¼/é˜²ç–«è³‡è¨Š", url: "#", icon: "ğŸ›¡ï¸" },
      ],
      dailyQuote: {
        quote: "å®¶åº­æ˜¯æˆ‘å€‘ç”Ÿå‘½ä¸­å”¯ä¸€çš„é¿é¢¨æ¸¯ã€‚",
        source: "Leo Tolstoy",
      },
    };

    // --- æ–°å¢æ´»å‹•è¡¨å–®å…ƒä»¶ ---
    const AddEventForm = ({ onClose, db, collectionRef }) => {
        const [title, setTitle] = useState('');
        const [dateTime, setDateTime] = useState('');
        const [isLoading, setIsLoading] = useState(false);
        const [error, setError] = useState(null);

        const handleSubmit = async (e) => {
            e.preventDefault();
            setError(null);
            
            if (!title || !dateTime) {
                setError("è«‹å¡«å¯«æ´»å‹•æ¨™é¡Œå’Œæ—¥æœŸ/æ™‚é–“ã€‚");
                return;
            }

            if (!db) {
                setError("è³‡æ–™åº«å°šæœªæº–å‚™å¥½ï¼Œè«‹ç¨å€™ã€‚");
                return;
            }

            setIsLoading(true);
            try {
                // å°‡æ—¥æœŸæ™‚é–“å­—ä¸²è½‰æ›ç‚º Date ç‰©ä»¶ï¼Œä¸¦å°‡å…¶å„²å­˜åˆ° Firestore
                const eventDate = new Date(dateTime);
                
                await addDoc(collectionRef, {
                    title,
                    timestamp: eventDate.getTime(), // å„²å­˜æ™‚é–“æˆ³è¨˜ä»¥ä¾¿æ’åº
                    datetime: eventDate.toISOString(), // å„²å­˜ ISO æ ¼å¼çš„æ—¥æœŸæ™‚é–“
                    createdAt: serverTimestamp(),
                });

                setTitle('');
                setDateTime('');
                onClose();
            } catch (err) {
                console.error("æ–°å¢æ´»å‹•å¤±æ•—: ", err);
                setError("æ–°å¢æ´»å‹•å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚");
            } finally {
                setIsLoading(false);
            }
        };

        // é è¨­æ—¥æœŸæ™‚é–“ç‚ºç•¶å‰æ™‚é–“ï¼Œä»¥æ–¹ä¾¿è¼¸å…¥
        useEffect(() => {
            const now = new Date();
            // æ ¼å¼åŒ–ç‚º YYYY-MM-DDTHH:MMï¼Œç¬¦åˆ input type="datetime-local" æ ¼å¼
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            setDateTime(`${year}-${month}-${day}T${hours}:${minutes}`);
        }, []);


        return (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={onClose}>
                <div 
                    className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl transform transition-all duration-300 scale-100"
                    onClick={(e) => e.stopPropagation()} // é˜»æ­¢é»æ“Šè¡¨å–®æ™‚é—œé–‰
                >
                    <h3 className="text-2xl font-bold text-indigo-600 mb-4">æ–°å¢å®¶åº­æ´»å‹•</h3>
                    
                    {error && (
                        <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl mb-4 text-sm" role="alert">
                            {error}
                        </div>
                    )}

                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label htmlFor="title" className="block text-sm font-medium text-gray-700 mb-1">æ´»å‹•æ¨™é¡Œ</label>
                            <input
                                id="title"
                                type="text"
                                value={title}
                                onChange={(e) => setTitle(e.target.value)}
                                className="w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                                placeholder="ä¾‹å¦‚ï¼šå°æ˜é‹¼ç´èª²ã€å®¶åº­é‡é¤"
                                required
                            />
                        </div>
                        <div>
                            <label htmlFor="dateTime" className="block text-sm font-medium text-gray-700 mb-1">æ—¥æœŸå’Œæ™‚é–“</label>
                            <input
                                id="dateTime"
                                type="datetime-local"
                                value={dateTime}
                                onChange={(e) => setDateTime(e.target.value)}
                                className="w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                                required
                            />
                        </div>

                        <div className="flex justify-end space-x-3 pt-2">
                            <button
                                type="button"
                                onClick={onClose}
                                className="px-4 py-2 text-gray-600 bg-gray-100 rounded-xl font-medium hover:bg-gray-200 transition duration-150"
                                disabled={isLoading}
                            >
                                å–æ¶ˆ
                            </button>
                            <button
                                type="submit"
                                className="px-4 py-2 text-white bg-indigo-600 rounded-xl font-medium hover:bg-indigo-700 shadow-md transition duration-150 flex items-center justify-center"
                                disabled={isLoading}
                            >
                                {isLoading ? (
                                    <svg className="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                ) : (
                                    'å„²å­˜æ´»å‹•'
                                )}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        );
    };


    // --- 1. è¡Œäº‹æ›† (Calendar View) ---
    const CalendarView = () => {
        const { firebase, db, isAuthReady } = useContext(FirebaseContext);
        const [events, setEvents] = useState([]);
        const [isLoading, setIsLoading] = useState(true);
        const [isModalOpen, setIsModalOpen] = useState(false);
        const [error, setError] = useState(null);

        // ç¢ºä¿ Firebase å’Œ Firestore å‡½å¼å¯ç”¨
        if (!firebase) return <div className="p-8 text-center text-red-500">Firebase è¼‰å…¥å¤±æ•—ã€‚</div>;

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const collectionPath = `artifacts/${appId}/public/data/familyEvents`;
        const collectionRef = db ? firebase.collection(db, collectionPath) : null;

        useEffect(() => {
            if (!isAuthReady || !db || !collectionRef) {
                // å¦‚æœèªè­‰æˆ–è³‡æ–™åº«æœªæº–å‚™å¥½ï¼Œå‰‡ä¸ç›£è½
                setIsLoading(true);
                return;
            }

            // è¨­ç½®å³æ™‚ç›£è½å™¨ (onSnapshot)
            try {
                // æŸ¥è©¢ï¼šæŒ‰ç…§ timestamp å‡åºæ’åˆ—
                const q = firebase.query(collectionRef, firebase.orderBy('timestamp', 'asc'));
                
                const unsubscribe = firebase.onSnapshot(q, (snapshot) => {
                    const fetchedEvents = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        // ç¢ºä¿ timestamp æ˜¯ä¸€å€‹æ•¸çµ„å¯ç”¨çš„æ•¸å­—
                        timestamp: doc.data().timestamp || new Date().getTime(),
                    }));
                    
                    // ç”±æ–¼æˆ‘å€‘åªé¡¯ç¤ºç•¶å‰é€±çš„äº‹ä»¶ï¼Œéœ€è¦éæ¿¾
                    const today = new Date();
                    const startOfWeek = new Date(today);
                    startOfWeek.setDate(today.getDate() - (today.getDay() === 0 ? 6 : today.getDay() - 1)); // æ˜ŸæœŸä¸€
                    startOfWeek.setHours(0, 0, 0, 0);

                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 7);
                    
                    const currentWeekEvents = fetchedEvents.filter(event => {
                        const eventDate = new Date(event.datetime);
                        return eventDate >= startOfWeek && eventDate < endOfWeek;
                    });
                    
                    setEvents(currentWeekEvents);
                    setIsLoading(false);
                }, (err) => {
                    console.error("Firestore ç›£è½å¤±æ•—: ", err);
                    setError("è¼‰å…¥æ´»å‹•æ¸…å–®æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚");
                    setIsLoading(false);
                });

                // æ¸…ç†ç›£è½å™¨
                return () => unsubscribe();
            } catch (e) {
                console.error("Firestore æŸ¥è©¢è¨­ç½®å¤±æ•—: ", e);
                setError("ç„¡æ³•è¨­å®šè³‡æ–™åº«é€£ç·šã€‚");
                setIsLoading(false);
            }
        }, [isAuthReady, db, firebase]); // ä¾è³´æ–¼èªè­‰ç‹€æ…‹å’Œ db å¯¦ä¾‹

        const calendarDays = ['ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'æ—¥'];
        const currentMonth = new Date().getMonth() + 1;
        const todayDay = new Date().getDay() === 0 ? 7 : new Date().getDay(); // 1(Mon) to 7(Sun)
        
        return (
            <div className="space-y-6">
                <div className="flex justify-between items-center">
                    <h2 className="text-2xl font-bold text-gray-800">
                        ğŸ—“ï¸ {currentMonth} æœˆæ´»å‹• (å³æ™‚æ›´æ–°)
                    </h2>
                    <button 
                        onClick={() => setIsModalOpen(true)}
                        className="flex items-center space-x-1 px-4 py-2 bg-indigo-600 text-white rounded-full shadow-lg hover:bg-indigo-700 transition duration-150 transform hover:scale-105"
                    >
                        <Plus className="w-5 h-5" />
                        <span className="text-sm font-medium">æ–°å¢æ´»å‹•</span>
                    </button>
                </div>

                <div className="grid grid-cols-7 gap-1 text-center font-medium text-sm border-b pb-2">
                    {calendarDays.map((day, index) => (
                        <div key={index} className={`p-2 rounded-lg ${index + 1 === todayDay ? 'bg-indigo-100 text-indigo-800' : 'text-gray-600'}`}>
                            <div className="text-xs font-light">{day}</div>
                        </div>
                    ))}
                </div>
                
                <div className="space-y-3">
                    <h3 className="text-lg font-semibold text-gray-700">è©³ç´°è¡Œç¨‹</h3>
                    
                    {isLoading && (
                        <div className="text-center p-8 text-indigo-500">
                            <svg className="animate-spin mx-auto h-8 w-8 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            <p className="mt-2">æ­£åœ¨å¾é›²ç«¯è¼‰å…¥æ´»å‹•...</p>
                        </div>
                    )}

                    {error && (
                        <div className="text-center p-4 bg-red-100 text-red-700 rounded-xl">
                            {error}
                        </div>
                    )}
                    
                    {!isLoading && events.length === 0 && !error && (
                        <div className="text-center p-8 bg-white rounded-xl shadow-lg text-gray-500">
                            ç›®å‰æ²’æœ‰ä»»ä½•æ´»å‹•ã€‚é»æ“Šå³ä¸Šè§’çš„ã€Œæ–°å¢æ´»å‹•ã€ä¾†è¦åŠƒæ‚¨çš„å®¶åº­è¡Œç¨‹å§ï¼
                        </div>
                    )}

                    {events.map((event) => (
                        <div 
                            key={event.id} 
                            className="flex items-center p-3 bg-white rounded-xl shadow-md border border-gray-100 hover:shadow-lg transition duration-150"
                        >
                            <div className="flex-shrink-0 w-16 text-center text-sm font-semibold text-indigo-600">
                                <p className="text-xs text-gray-500">{formatDate(event.datetime)}</p>
                                <p className="text-lg font-bold">{formatTime(event.datetime)}</p>
                            </div>
                            <div className="ml-4 flex-grow">
                                <p className="text-gray-900 font-medium text-lg">{event.title}</p>
                            </div>
                            <ChevronRight className="h-5 w-5 text-gray-400" />
                        </div>
                    ))}
                </div>
                
                {isModalOpen && (
                    <AddEventForm 
                        onClose={() => setIsModalOpen(false)} 
                        db={db}
                        collectionRef={collectionRef}
                    />
                )}
            </div>
        );
    };

    // --- å…¶ä»–åŠŸèƒ½çµ„ä»¶ (ç•¥ï¼Œä¿æŒä¸è®Š) ---
    // 2. å®¶è¦ (House Rules)
    const RulesView = ({ rules }) => (
      <div className="space-y-4">
        <h2 className="text-xl font-bold text-red-600 flex items-center">
          <Scroll className="w-6 h-6 mr-2" />
          æˆ‘å€‘çš„å®¶è¦
        </h2>
        <ul className="space-y-3 p-4 bg-white rounded-xl shadow-lg border border-red-100">
          {rules.map((rule, index) => (
            <li key={index} className="flex items-start text-gray-700">
              <span className="flex-shrink-0 text-red-500 font-extrabold mr-3">{index + 1}.</span>
              <p className="flex-grow">{rule}</p>
            </li>
          ))}
        </ul>
      </div>
    );

    // 3. å°æœ‹å‹æ¦®è­½æ¦œ (Kids' Honor Roll)
    const HonorRollView = ({ honorRoll }) => (
      <div className="space-y-4">
        <h2 className="text-xl font-bold text-yellow-600 flex items-center">
          <Trophy className="w-6 h-6 mr-2 fill-yellow-400" />
          å°æœ‹å‹æ¦®è­½æ¦œ
        </h2>
        <div className="space-y-3">
          {honorRoll.sort((a, b) => b.points - a.points).map((kid, index) => (
            <div 
              key={index} 
              className={`flex items-center p-4 rounded-xl shadow-md transition duration-300 ease-in-out ${
                index === 0 ? 'bg-yellow-50 border-2 border-yellow-400 scale-105' : 'bg-white border border-gray-100'
              }`}
            >
              <div className="text-3xl font-bold w-12 text-center">
                {index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : 'âœ¨'}
              </div>
              <div className="ml-4 flex-grow">
                <p className="text-lg font-semibold text-gray-800">{kid.name}</p>
                <p className="text-sm text-gray-500 truncate">{kid.achievement}</p>
              </div>
              <div className="text-right">
                <p className="text-xl font-extrabold text-green-600">{kid.points}</p>
                <p className="text-xs text-green-500">ç©åˆ†</p>
              </div>
            </div>
          ))}
        </div>
        <div className="text-center text-sm text-gray-500 pt-2">
          <button className="text-indigo-600 font-medium hover:underline">
            æŸ¥çœ‹ç©åˆ†æ­·å²è¨˜éŒ„...
          </button>
        </div>
      </div>
    );

    // 4. é‡è¦è³‡è¨Šå®£å° (Important Information/Announcements)
    const AnnouncementsView = ({ announcements, dailyQuote }) => (
      <div className="space-y-6">
        <h2 className="text-xl font-bold text-blue-600 flex items-center">
          <Megaphone className="w-6 h-6 mr-2" />
          é‡è¦è³‡è¨Šå®£å°
        </h2>
        
        <div className="space-y-3 p-4 bg-blue-50 rounded-xl shadow-lg border border-blue-200">
          {announcements.map((announcement, index) => (
            <div key={index} className="flex items-center">
              <span className="flex-shrink-0 text-blue-500 font-extrabold mr-3">ğŸ“¢</span>
              <p className="text-gray-700">{announcement}</p>
            </div>
          ))}
        </div>

        <h2 className="text-xl font-bold text-pink-600 flex items-center pt-4">
          <MessageSquare className="w-6 h-6 mr-2" />
          æ¯æ—¥ä¸€å¥åˆ†äº«
        </h2>
        <div className="p-5 bg-white rounded-xl shadow-lg border border-pink-200 italic text-center">
          <p className="text-xl font-serif text-gray-800 mb-2">ã€Œ{dailyQuote.quote}ã€</p>
          <p className="text-sm text-gray-500">â€”â€” {dailyQuote.source}</p>
        </div>
      </div>
    );

    // 5. å¸¸ç”¨æŸ¥è©¢ (Common Queries/Links)
    const QueriesView = ({ queries }) => (
      <div className="space-y-4">
        <h2 className="text-xl font-bold text-purple-600 flex items-center">
          <Search className="w-6 h-6 mr-2" />
          å¸¸ç”¨æŸ¥è©¢èˆ‡é€£çµ
        </h2>
        <div className="grid grid-cols-2 gap-3">
          {queries.map((query, index) => (
            <a 
              key={index} 
              href={query.url} 
              target="_blank" 
              rel="noopener noreferrer"
              className="flex flex-col items-center justify-center p-4 bg-white rounded-xl shadow-md hover:bg-purple-50 transition duration-150 ease-in-out transform hover:scale-105"
            >
              <div className="text-4xl mb-2">{query.icon}</div>
              <p className="text-sm font-semibold text-gray-700 text-center">{query.title}</p>
            </a>
          ))}
        </div>
        <div className="p-4 bg-gray-50 rounded-lg text-sm text-gray-600 mt-4">
          <p>âš ï¸ æ³¨æ„ï¼šç›®å‰é€™äº›é€£çµåƒ…ç‚ºç¤ºç¯„ï¼Œé»æ“Šå¾Œä¸æœƒè·³è½‰åˆ°å¯¦éš›ç¶²ç«™ã€‚</p>
        </div>
      </div>
    );


    // --- ä¸»è¦æ‡‰ç”¨ç¨‹å¼ (Main App) ---
    const TABS = [
      { id: 'calendar', label: 'è¡Œäº‹æ›†', Icon: Calendar, color: 'text-indigo-600' },
      { id: 'info', label: 'è³‡è¨Š/åˆ†äº«', Icon: Megaphone, color: 'text-blue-600' },
      { id: 'rules', label: 'å®¶è¦', Icon: Scroll, color: 'text-red-600' },
      { id: 'honor', label: 'æ¦®è­½æ¦œ', Icon: Trophy, color: 'text-yellow-600' },
      { id: 'queries', label: 'å¸¸ç”¨æŸ¥è©¢', Icon: Search, color: 'text-purple-600' },
    ];

    const App = () => {
      const [activeTab, setActiveTab] = useState('calendar');
      const [firebaseState, setFirebaseState] = useState({ db: null, auth: null, userId: null, isAuthReady: false, firebase: null });

      // Firebase åˆå§‹åŒ–èˆ‡èªè­‰
      useEffect(() => {
          const initFirebase = async () => {
              const firebase = getFirebaseDependencies();
              if (!firebase) return;

              try {
                  const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                  const app = firebase.initializeApp(firebaseConfig);
                  const db = firebase.getFirestore(app);
                  const auth = firebase.getAuth(app);
                  
                  // è¨­å®š Firebase æœå‹™ç‹€æ…‹
                  setFirebaseState(prev => ({ ...prev, db, auth, firebase }));

                  // ç™»å…¥è™•ç†
                  if (typeof __initial_auth_token !== 'undefined') {
                      await firebase.signInWithCustomToken(auth, __initial_auth_token);
                  } else {
                      await firebase.signInAnonymously(auth);
                  }

                  // ç›£è½èªè­‰ç‹€æ…‹è®ŠåŒ–
                  firebase.onAuthStateChanged(auth, (user) => {
                      const userId = user?.uid || crypto.randomUUID();
                      setFirebaseState(prev => ({ ...prev, userId, isAuthReady: true }));
                  });

              } catch (error) {
                  console.error("Firebase åˆå§‹åŒ–æˆ–èªè­‰å¤±æ•—: ", error);
                  setFirebaseState(prev => ({ ...prev, isAuthReady: true })); // å³ä½¿å¤±æ•—ä¹Ÿè¦æ¨™è¨˜ç‚ºå°±ç·’
              }
          };

          initFirebase();
      }, []); // åªåœ¨å…ƒä»¶æ›è¼‰æ™‚åŸ·è¡Œä¸€æ¬¡

      const renderContent = useMemo(() => {
        switch (activeTab) {
          case 'calendar':
            return <CalendarView />; // CalendarView ç¾åœ¨å¾ context ç²å–æ•¸æ“š
          case 'rules':
            return <RulesView rules={mockData.rules} />;
          case 'honor':
            return <HonorRollView honorRoll={mockData.honorRoll} />;
          case 'info':
            return <AnnouncementsView announcements={mockData.announcements} dailyQuote={mockData.dailyQuote} />;
          case 'queries':
            return <QueriesView queries={mockData.queries} />;
          default:
            return <div className="text-center p-8 text-gray-500">é¸æ“‡ä¸€å€‹åŠŸèƒ½</div>;
        }
      }, [activeTab]);

      return (
        <FirebaseContext.Provider value={firebaseState}>
          <div className="min-h-screen bg-gray-50 font-sans antialiased flex flex-col items-center">
            
            {/* é ‚éƒ¨æ¨™é¡Œå€åŸŸ */}
            <header className="w-full max-w-lg bg-white border-b border-gray-200 shadow-sm p-4 sticky top-0 z-10">
              <h1 className="text-2xl font-extrabold text-center text-gray-900">
                ğŸ å®¶åº­ä¸­å¿ƒ
              </h1>
              <p className="text-center text-sm text-gray-500">
                Family Hub
              </p>
            </header>
            
            {/* å…§å®¹å€åŸŸ */}
            <main className="w-full max-w-lg p-4 pb-24 flex-grow">
              {firebaseState.isAuthReady ? renderContent : (
                <div className="text-center p-10 text-indigo-500">
                  <svg className="animate-spin mx-auto h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                  <p className="mt-2">æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–ä¸­...</p>
                </div>
              )}
            </main>

            {/* åº•éƒ¨å°èˆªæ¬„ (Mobile Navigation) */}
            <nav className="fixed bottom-0 w-full max-w-lg bg-white border-t border-gray-200 shadow-xl z-20">
              <div className="flex justify-around h-16">
                {TABS.map((tab) => (
                  <button
                    key={tab.id}
                    onClick={() => setActiveTab(tab.id)}
                    className={`flex flex-col items-center justify-center flex-grow transition duration-150 ease-in-out ${
                      activeTab === tab.id
                        ? `${tab.color} font-bold transform scale-110`
                        : 'text-gray-500 hover:text-gray-700'
                    }`}
                  >
                    <tab.Icon className="w-6 h-6" />
                    <span className="text-xs mt-0.5">{tab.label}</span>
                  </button>
                ))}
              </div>
            </nav>
            
          </div>
        </FirebaseContext.Provider>
      );
    };

    // æ¸²æŸ“æ‡‰ç”¨ç¨‹å¼
    const container = document.getElementById('root');
    const root = createRoot(container);
    root.render(<App />);
    </script>
</body>
</html>
